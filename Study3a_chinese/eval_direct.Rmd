---
title: 'Pre-Registration Experiment 1a: Direct evalautive ratings'
author: "Kathrin Reichmann"
date: "26 5 2021"
input: "direct.csv"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## General Information

The second task participants will do in the experiment is a direct evaluative rating task of CSs, GSs (stimuli from the same categories) and Distractors (unrelated stimuli) -> "type_specific" . CSs stem from one of four different categories. Categories were either paired with positive USs, or with negative USs.CSs consisted of chinese characters with two components: one component defined the category-membership (predictive component), the other varied between exemplars (non-predictive component).

Direct Evaluative Ratings are conducted on a -100 to 100 scale. 

Category size of categories is varied between-subjects (one: one exemplar per category vs. many: five exemplars per category).

```{r prep, echo = FALSE, include = FALSE}
#set directory
#setwd("\\\\sn00.zdv.uni-tuebingen.de/siskr01/Documents/Github/CSCond_analysis/CSCond_analysis/data")
knitr::opts_knit$set(root.dir = "C:/Users/reich/Documents/GitHub/CSCond_analysis/Study1_EC/data")

#load packages
library(dplyr)
library(tidyverse)
library(ggplot2)
library(lme4)

#functions
CI <- function(x) qnorm(0.975)*sd(x)/sqrt(length(x))
se <- function(x) sd(x)/sqrt(length(x))

```

```{r prepare data for generalization analysis, echo = FALSE, include = FALSE}

#read table
direct <- read.csv2('direct.csv', header = TRUE)
str(direct)

#convert to factor
as_factor <- c("subject", "val", "condition_code", "condition", "measure", "measure_code", "type", "type_specific", "category", "cs_selected")

for (factor in as_factor){
  direct[, factor] <- as.factor(direct[,factor])
}

direct$type_specific <- factor(direct$type_specific, levels = c("CS", "GS same", "GS different", "Feature", "Group"))

#!! change in new study?
## randomly select 1 CSs for many_one:
new_one <- direct[direct$condition == "one_one",]
new_many <- direct[direct$condition == "many_one",]
new_many <- new_many[!new_many$type_specific == "CS",]
new_direct <- rbind(new_one, new_many)

for (subject in unique(direct$subject)){
  if (direct$condition[direct$subject == subject] == "many_one"){
    for (cat in 1:4){
      temp <- direct[direct$subject == subject & direct$type_specific == "CS" & direct$category == cat,]
      select <- temp[1,]
      new_direct <- rbind(new_direct, select)
    }
  }
}

#!! Change in new study?
## exclude "Group" and "Feature" and "GSnew" for now.
new_direct$type <- NULL
new_direct <- new_direct[!new_direct$type_specific == "Group",]
new_direct <- new_direct[!new_direct$type_specific == "Feature",]
new_direct <- new_direct[!new_direct$type_specific == "GS different",]

## rename many_one to many and one_one to one
new_direct$condition <- factor(new_direct$condition, labels = c("many", "one"), levels = c("many_one", "one_one"))


#data frame taking each stimulus (cs_selected) into account
HLMprep <- aggregate(response ~ subject + condition + val + type_specific + category + cs_selected, new_direct, mean)
HLMprep$nr_obs <- aggregate(response ~ subject + condition + val + type_specific + category + cs_selected, new_direct, length)[[7]]

#!! check with Mandy
#calculate difference scores
HLMprep <- HLMprep[order(HLMprep$subject, HLMprep$val, HLMprep$type_specific),]

HLMpos <- HLMprep[HLMprep$val == "pos",]
HLMpos$pos <- HLMpos$response
HLMpos$response <- NULL
head(HLMpos)

HLMneg <- HLMprep[HLMprep$val == "neg",]
HLMneg$neg <- HLMneg$response
HLM <- cbind(HLMpos, HLMneg$neg, HLMneg$category)
head(HLM)

HLM$val <- NULL
HLM$neg <- HLM$`HLMneg$neg`
HLM$`HLMneg$neg` <- NULL
dim(HLM)

HLM$diff <- HLM$pos - HLM$neg

# variable with type as a continuous predictor
HLM$type_continuous <- factor(HLM$type_specific, labels = c("0", "1"), levels = c("CS", "GS same"))
HLM$type_continuous <- as.numeric(HLM$type_continuous)

# variable with type as discrete predictor
HLM$type_discrete <- factor(HLM$type_specific, labels = c("CS", "GS"), levels = c("CS", "GS same"))

```

## (1) Testing H1: Generalization

### Hypothesis 1: 
(1) Generalization towards novel stimuli is more pronounced in the "many" condition than in the "one" condition.


* Significant cross-level interaction stimulus type x condition.*
  + no effect of condition on difference scores for **CSs**
  + effect of condition on difference scores for **GSs** : higher difference scores in the "many" condition than in the "one" condition
  + no effect of condition on difference scores for **distractors**

Dummy Coded Stimulus Type (0 - CS, 1 - GS) and Condition (0 - Many, 1 - One)

### Plot raw data: 

```{r plot raw data, include = TRUE, echo = FALSE}

#plot some individual slopes for condition "one"
indPlotData <- HLM[1:280,]
indPlotData <- indPlotData[order(indPlotData$subject),]
indPlot3 <- ggplot(indPlotData[!indPlotData$condition == "one",], aes(x = type_discrete, y = diff, group = subject, color = condition, shape = condition)) +
  facet_wrap(.~ subject, nrow = 5) +
  geom_point(show.legend = TRUE, alpha = .6) +
  geom_smooth(method = "lm", alpha = .6, se = FALSE) +  
  scale_color_brewer(palette = "Paired") 
indPlot3

#plot some individual slopes for condition "many"
indPlotData <- HLM[1:280,]
indPlotData <- indPlotData[order(indPlotData$subject),]
indPlot3 <- ggplot(indPlotData[!indPlotData$condition == "one",], aes(x = type_discrete, y = diff, group = subject, color = condition, shape = condition)) +
  facet_wrap(.~ subject, nrow = 5) +
  geom_point(show.legend = TRUE, alpha = .6) +
  geom_smooth(method = "lm", alpha = .6, se = FALSE) +  
  scale_color_brewer(palette = "Paired") 
indPlot3


#aggregate data
HLMdotplot <- aggregate(diff ~ subject + type_discrete + condition, HLM, mean)
means <- aggregate(diff ~ condition + type_discrete, HLM, mean)
means$se <- aggregate(diff ~ condition + type_discrete, HLM, se)[[3]]
means

#plot every single participant
dotplot1 <- ggplot(HLMdotplot, aes (x = type_discrete, y = diff, group = subject, color = condition, shape = condition)) +
  geom_line() +
  geom_point(show.legend = TRUE, alpha = .4) +
  geom_point(data = means, size = 4, alpha = .9) +
  geom_line(data = means, mapping = aes(group = condition), color = "red", size = 1) +
  scale_color_brewer(palette = "Paired") +
  scale_x_discrete(name = "\nStimulus Type") +
  scale_y_continuous (name = "Difference Scores for subjects i and stimulus j\n", breaks = seq(-100, 200, 50), limits = c(-100, 200)) + 
  theme_classic() +
  ggtitle("Raw Data") +
  labs(fill = "Condition") +
  theme(plot.title = element_text (hjust = 0.5, face = "bold", size = 12))
dotplot1

#barplot with standard errors
barplotDiff <- ggplot(means, aes (x = type_discrete, y = diff, fill = condition)) +
  geom_bar(stat = 'identity', position = position_dodge(), show.legend = TRUE) +
  geom_errorbar(aes(ymin= diff - se, ymax= diff + se), width=.2,
                position=position_dodge(.9)) +
  ggtitle("Mean Differences (with Standard Errors)") + 
  scale_fill_brewer(palette = "Paired") +
  scale_x_discrete(name = "\nType") +
  scale_y_continuous (name = "Mean Difference Scores\n", breaks = seq(0, 100, 10), limits = c(0, 100)) + 
  theme_classic() +
  labs(fill = "Condition") +
  theme(plot.title = element_text (hjust = 0.5, face = "bold", size = 12))
barplotDiff


```

### MOdel 1: random intercept, fixed effect of stimulus type

```{r model 1, echo = TRUE, include = TRUE}
##### random intercept model with fixed effect of stimulus type
model1 <- lmer(diff ~ type_discrete + (1|subject), data = HLM, REML = FALSE)
summary(model1, correlation = FALSE)

```
```{r plot model1, echo = FALSE, include = TRUE}

#create data frame for plotting random effects
random1CS <- data.frame(diff = coef(model1)$subject[,1], type_discrete = "CS", subject = rownames(coef(model1)$subject))
random1GS <- data.frame(diff = coef(model1)$subject[,1] + coef(model1)$subject[,2], type_discrete = "GS", subject = rownames(coef(model1)$subject))
random1 <- rbind(random1CS, random1GS)

#fixed effect
fix1CS <- data.frame(diff = summary(model1)$coef[1, "Estimate"], type_discrete = "CS")
fix1GS <- data.frame(diff = summary(model1)$coef[1, "Estimate"] + summary(model1)$coef[2, "Estimate"], type_discrete = "GS")
fix1 <- rbind(fix1CS, fix1GS)
fix1

plotModel1 <- ggplot(random1, aes (x = as.factor(type_discrete), y = diff, group = as.factor(subject))) +
  geom_line(color = "grey") +
  geom_point(color = "grey") +
  geom_line(data = fix1, mapping = aes(y = diff, x = type_discrete, group = 1), color = "red", size = 1) +
  geom_point(data = fix1, mapping = aes(y = diff, x = type_discrete, group = 1), color = "red", size = 1.5) +
  scale_color_brewer(palette = "Paired") +
  scale_x_discrete (name = "\nStimulus Type", limits=c("CS","GS")) +
  scale_y_continuous (name = "Difference Scores for subjects i and stimulus j\n", breaks = seq(-100, 200, 50), limits = c(-100, 200)) + 
  theme_classic() +
  ggtitle("Data fitted under Model 1") +
  labs(fill = "condition\n subject i") +
  theme(plot.title = element_text (hjust = 0.5, face = "bold", size = 12))
plotModel1  


```

### Model 2: + random slope

```{r model 2}
##### + random slope
model2 <- lmer(diff ~ type_discrete + (type_discrete|subject), data = HLM, REML = FALSE)
summary(model2, correlation = FALSE)

```

```{r plot model 2, include = TRUE, echo = FALSE}

#create data frame for plotting random effects
random2CS <- data.frame(diff = coef(model2)$subject[,1], type_discrete = "CS", subject = rownames(coef(model2)$subject))
random2GS <- data.frame(diff = coef(model2)$subject[,1] + coef(model2)$subject[,2], type_discrete = "GS", subject = rownames(coef(model2)$subject))
random2 <- rbind(random2CS, random2GS)

#fixed effect
fix2CS <- data.frame(diff = summary(model2)$coef[1, "Estimate"], type_discrete = "CS")
fix2GS <- data.frame(diff = summary(model2)$coef[1, "Estimate"] + summary(model2)$coef[2, "Estimate"], type_discrete = "GS")
fix2 <- rbind(fix2CS, fix2GS)
fix2

plotModel2 <- ggplot(random2, aes (x = as.factor(type_discrete), y = diff, group = as.factor(subject))) +
  geom_line(color = "grey") +
  geom_point(color = "grey") +
  geom_line(data = fix2, mapping = aes(y = diff, x = type_discrete, group = 1), color = "red", size = 1) +
  geom_point(data = fix2, mapping = aes(y = diff, x = type_discrete, group = 1), color = "red", size = 1.5) +
  scale_color_brewer(palette = "Paired") +
  scale_x_discrete (name = "\nStimulus Type", limits=c("CS","GS")) +
  scale_y_continuous (name = "Difference Scores for subjects i and stimulus j\n", breaks = seq(-100, 200, 50), limits = c(-100, 200)) + 
  theme_classic() +
  ggtitle("Data fitted under Model 2") +
  labs(fill = "condition\n subject i") +
  theme(plot.title = element_text (hjust = 0.5, face = "bold", size = 12))
plotModel2 

```

### + condition (between-subjects variable)

```{r, include = TRUE, echo = TRUE}
model3 <- lmer(diff ~ type_discrete*condition + (type_discrete|subject), data = HLM, REML = FALSE)

```


### Model comparisons: 

```{r echo = TRUE, include = TRUE}
#model comparison
anova(model1, model2, model3)

```

Interpretation: 

+ The difference in deviance between Model 1 and Model 2 is not significant X²(2, 1594) = 2.48, p = .288. This indicates that including a random slope effect does not contribute to a better fitting model than a mere random intercept effect.

+ The difference in deviance between Model 2 and Model 3 is significant X²(2, 1592) = 20.97, p < .001. The inclusion of „condition“ as a cross-level interaction with stimulus type significantly contributes to the fit of the model, meaning that „condition“ explains variability in the intercept and slope. *(nimmt jedoch von model 2 auf model 3 zu) *

+ *For final model, omit random slope effect?*


### Results of MOdel 3:

```{r echo = FALSE, include = TRUE}
summary(model3, correlation = FALSE)
```

Interpretation: 

+ **intercept estimate:** mean difference score for „CS“ is 64.16 in the „many“ condition.

+ **ConditionOne [Gruppeneffekt]:**  On average, the difference score is reduced by 0.75 points for CSs in the „one“ condition in comparison to CSs in the „many“ condition. -> corresponds to first line of hypotheses

+ **Type_discreteGS [Generalisierung]:** In the „many“ condition, the mean difference score is reduced by -17.39 points for GSs, in comparison to CSs. 

+ **Type_discreteGS:conditionOne:** Average decrease of difference scores from „CS“ to „GS“ by -22.91 points for „one“ condition beyond the decrease of difference scores from „CS“ to „GS“ for „many“ condition. Wider generalization in „many“-> *main hypothesis of the study*

+ **Random intercept [45.72]:** variation of intercept across subjects: variation goes beyond the fixed effect of stimulus type [-17.39]

+ **Random slopes [8.22]:** variation of slopes across subjects: individual differences in the degree of generalizationm -> individuals differ beyond the individual differences explained by the „condition“ variable


```{r plot model 3, include = TRUE, echo = FALSE}
#create data frame for plotting random effects
subjcond <- HLM[!duplicated(HLM$subject),c("subject", "condition")] ##add condition

random3CS <- data.frame(diff = coef(model3)$subject[,1], type_discrete = "CS", subject = rownames(coef(model3)$subject))
random3CS <- merge(random3CS, subjcond, by.y = "subject")

random3GS <- data.frame(diff = coef(model3)$subject[,1] + coef(model3)$subject[,2], type_discrete = "GS", subject = rownames(coef(model3)$subject))
random3GS <- merge(random3GS, subjcond, by.y = "subject")

random3 <- rbind(random3CS, random3GS)

#fixed effect
fix3CSMany <- data.frame(diff = summary(model3)$coef[1, "Estimate"], type_discrete = "CS")
fix3GSMany <- data.frame(diff = summary(model3)$coef[1, "Estimate"] + summary(model3)$coef[2, "Estimate"], type_discrete = "GS")
fix3Many <- rbind(fix3CSMany, fix3GSMany)
fix3Many

fix3CSOne <- data.frame(diff = summary(model3)$coef[1, "Estimate"] + summary(model3)$coef[3, "Estimate"], type_discrete = "CS")
fix3GSOne <- data.frame(diff = (summary(model3)$coef[1, "Estimate"] + summary(model3)$coef[3, "Estimate"]) + (summary(model3)$coef[2, "Estimate"] + summary(model3)$coef[4, "Estimate"]), type_discrete = "GS")
fix3One <- rbind(fix3CSOne, fix3GSOne)
fix3One


plotModel3 <- ggplot(random3, aes (x = as.factor(type_discrete), y = diff, group = as.factor(subject), color = condition)) +
  geom_line(alpha = .6) +
  geom_point(alpha = .4) +
  geom_line(data = fix3Many, mapping = aes(y = diff, x = type_discrete, group = 1), color = "red", size = 1) +
  geom_point(data = fix3Many, mapping = aes(y = diff, x = type_discrete, group = 1), color = "red", size = 1.5) +
  geom_text(data = fix3Many, mapping = aes(y = diff, x = type_discrete, group = 1), label = "many", color = "red", vjust = -1) +
  geom_line(data = fix3One, mapping = aes(y = diff, x = type_discrete, group = 1), color = "darkred", size = 1) +
  geom_point(data = fix3One, mapping = aes(y = diff, x = type_discrete, group = 1), color = "darkred", size = 1.5) +
  geom_text(data = fix3One, mapping = aes(y = diff, x = type_discrete, group = 1), label = "one", color = "darkred", vjust = 1) +
  scale_color_brewer(palette = "Paired") +
  scale_x_discrete (name = "\nStimulus Type", limits=c("CS","GS")) +
  scale_y_continuous (name = "Difference Scores for subjects i and stimulus j\n", breaks = seq(-100, 200, 50), limits = c(-100, 200)) + 
  theme_classic() +
  ggtitle("Data fitted under Model 3") +
  theme(plot.title = element_text (hjust = 0.5, face = "bold", size = 12))
plotModel3 
```

```{r use model 3 to plot individual slopes}



```


## (1) Testing H2: CS Components

### Hypothesis 2: 
(2) Evaluative ratings differ between predictive and non-predictive components for "many" condition. No difference between the components in the "one" condition.

Explanation: In the „many“ condition, the EC effect gets attached to the category-defining feature, while in the „one“ condition, the EC effect gets attached to the whole stimulus

* Significant cross-level interaction stimulus component x condition.*
  + no difference between components in **"one" condition**
  + significant difference between components in the **many condition** : higher difference scores for the "predictive" component than the "non-predictive" component

Dummy Coded Stimulus Component (0 - Non-Predictive , 1 - Predictive) and Condition (0 - Many, 1 - One)

### Plot raw data: 



(2) 

